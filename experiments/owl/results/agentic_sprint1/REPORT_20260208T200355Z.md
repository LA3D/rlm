# Agentic OWL+SHACL Sprint-1 Report (Post-Fix Run)

## Run Metadata

- Timestamp: `20260208T200355Z`
- Objective: Re-run sprint-1 competency questions (`CQ1..CQ5`) after architectural fixes:
  - handle-first validation/reporting
  - additive RDF operators
  - CQ anchor-aware mutation gating
  - episode memory write-back
- Main model: `anthropic/claude-sonnet-4-5-20250929`
- Sub-model: `anthropic/claude-haiku-4-5-20251001`
- Ontology input: `ontology/core-vocabulary.ttl`
- SHACL input: `ontology/core-shapes.ttl`
- Runner: `experiments/owl/agentic_owl_runner.py`

## Repro Command

```bash
~/uvws/.venv/bin/python experiments/owl/agentic_owl_runner.py \
  --ontology-path ontology/core-vocabulary.ttl \
  --shapes-path ontology/core-shapes.ttl \
  --out-dir experiments/owl/results/agentic_sprint1
```

## Artifacts

- Summary: `experiments/owl/results/agentic_sprint1/summary_20260208T200355Z.json`
- Trajectory JSONL: `experiments/owl/results/agentic_sprint1/trajectory_20260208T200355Z.jsonl`
- Final graph snapshot: `experiments/owl/results/agentic_sprint1/working_graph_20260208T200355Z.ttl`

## Headline Results

- CQ pass rate: `0/5` (`0%`)
- Final SHACL conformance: `false`
- Final SHACL validation results: `23`
- Final graph size: `128` triples
- Total tokens: `540,836`
- Total cost: `2.024316`

## Pre/Post Comparison vs Baseline (`20260208T192935Z`)

| Metric | Baseline | Post-Fix Run | Delta |
|---|---:|---:|---:|
| CQ pass rate | `3/5` | `0/5` | `-3` passes |
| Final SHACL conforms | `false` | `false` | unchanged |
| Final SHACL result count | `29` | `23` | `-6` |
| Total tokens | `494,183` | `540,836` | `+46,653` |
| Total cost | `1.933356` | `2.024316` | `+0.090960` |
| Large returns (sum) | `30` | `31` | `+1` |
| Memory items persisted | `0` | `5` episodes | `+5` |

Interpretation:
- Architecture changes improved memory instrumentation (episodes persisted), but task success regressed sharply.
- SHACL total violations reduced, but not in a way that translated to CQ correctness.

## Per-CQ Results

| CQ | Passed | SHACL Conforms | Iterations | Tokens | Cost | Large Returns | Memory Episode |
|---|---:|---:|---:|---:|---:|---:|---|
| CQ1 | false | false | 13 | 109,617 | 0.419091 | 4 | `9fd2380098d6` |
| CQ2 | false | false | 12 | 75,341 | 0.289095 | 5 | `9d6d250351fb` |
| CQ3 | false | false | 13 | 113,220 | 0.417276 | 9 | `85153dbf393b` |
| CQ4 | false | false | 15 | 114,816 | 0.427332 | 5 | `a40acd8abf18` |
| CQ5 | false | false | 13 | 127,842 | 0.471522 | 8 | `d9145c5cf8ac` |

## Trajectory Statistics

- Total events: `566`
- Event mix:
  - `run_start`: `5`
  - `run_complete`: `5`
  - `iteration`: `66`
  - `tool_call`: `245`
  - `tool_result`: `245`
- Top tool calls (global):
  - `handle_read_window`: `84`
  - `ontology_node_outgoing`: `58`
  - `op_set_single_literal`: `52`
  - `ontology_validate`: `46`
  - `cq_eval`: `44`
  - `cq_query_read_window`: `34`

## Behavioral Findings

1. The agent over-indexed on nested handle reads:
   - `handle_read_window` became the dominant tool by a wide margin.
   - The policy of "window returns become handles" induced repeated handle-on-handle traversal loops.
2. CQ/task progress degraded despite correct architectural guardrails:
   - CQ anchor gating worked, but the model frequently failed to recover actionable query semantics from handle chains.
3. Additive operators were used, especially in CQ5:
   - `op_add_iri_link` appeared in successful structural edits, but was insufficient to recover overall CQ pass behavior.
4. Memory write-back is now functioning:
   - One `Episode` persisted per CQ (`5` total), enabling downstream pattern analysis.

## Failure Analysis

### Primary Regression Driver

- **Progressive disclosure became too opaque for this prompting setup.**
- The model repeatedly read nested handles instead of converging on direct CQ-aligned edits.
- CQ4 answer explicitly indicates inability to recover required query details from nested handle references.

### Secondary Issues

- **Large-return pressure was not materially reduced** (`31` vs `30`) because validation + node inspection payloads remain moderately large.
- **No principle compilation occurred** (`compiled_principles: []`) since pattern repetition threshold was not met.

## Architectural Status vs RLM Goals

What improved:
- Validation is now handle-first with compact signature summaries.
- CQ anchor-aware mutation controls are in place.
- Memory episodes are persisted for each trajectory.

What remains problematic:
- Handle traversal ergonomics currently induce agentic loops and reduce solve rate.
- Prompt/query extraction needs an intermediate symbolic representation that is easier for the model to act on than recursive handle paging.

## Recommended Next Fixes

1. Add a compact `cq_query_symbols(cq_id)` tool:
   - Return parsed symbolic targets (subject IRIs, required predicates, literal regex constraints) without raw query text.
2. Add `handle_read_window` depth/chain guard:
   - Return explicit `depth` and stop recursive re-wrapping after one level for the same source key.
3. Add focused validation helpers:
   - `ontology_validate_focus(cq_id)` returning only CQ-relevant signature subsets.
4. Tighten tool-use policy in context:
   - Explicitly cap handle reads per iteration and prioritize `cq_eval` delta loops.
5. Compile principles from episodes offline first:
   - Generate initial `Principle` items from this runâ€™s 5 episodes to bootstrap memory-guided repair.

## Conclusion

The post-fix run validates the **architecture changes themselves** (handle-first validation, additive ops, memory write-back), but exposes a new **agentic usability regression**: the model spends too much budget traversing nested handles and too little on CQ-targeted state transitions. The next iteration should keep the RLM-safe architecture while introducing higher-level symbolic query extraction and stricter handle traversal controls.
