#!/usr/bin/env python3
"""E4 Simple Test - Just one query to debug the issue"""

import sys
import os
from pathlib import Path
from datetime import datetime
import json

# Add project root
project_root = Path(__file__).parent.parent.parent
sys.path.insert(0, str(project_root))

import dspy
from rdflib import Graph, RDF, RDFS, OWL, Namespace
from rlm_runtime.interpreter.namespace_interpreter import NamespaceCodeInterpreter

print("Loading ontology...")
ontology_path = project_root / "ontology" / "prov.ttl"
ont = Graph()
ont.parse(ontology_path)
print(f"Loaded {len(ont)} triples")

print("\nLoading guide...")
guide_path = project_root / "experiments" / "ontology_exploration" / "e3_retry_guide.json"
with open(guide_path, 'r') as f:
    guide = json.load(f)
print(f"Guide loaded: {len(guide.get('semantic_categories', []))} categories")

print("\nConfiguring DSPy...")
lm = dspy.LM("anthropic/claude-sonnet-4-5-20250929", max_tokens=4096)
dspy.configure(lm=lm)

print("\nTesting WITH guide (should be faster)...")

class QueryConstructionSig(dspy.Signature):
    """Construct a SPARQL query to answer a question."""
    question: str = dspy.InputField()
    guide_summary: str = dspy.InputField(desc="Summary of ontology guide")
    ont: object = dspy.InputField(desc="The loaded rdflib Graph")

    sparql_query: str = dspy.OutputField()
    explanation: str = dspy.OutputField()

interpreter = NamespaceCodeInterpreter(result_truncation_limit=5000)
tools = {'RDF': RDF, 'RDFS': RDFS, 'OWL': OWL, 'Namespace': Namespace}

rlm = dspy.RLM(
    QueryConstructionSig,
    max_iterations=10,
    max_llm_calls=8,
    verbose=True,
    interpreter=interpreter,
    tools=tools,
)

# Create a SHORT guide summary instead of passing full 41K JSON
guide_summary = f"""
PROV Ontology Quick Reference:

Core Classes:
- prov:Activity - Actions that occur over time
- prov:Entity - Things (physical, digital, conceptual)
- prov:Agent - Things that bear responsibility

Key Properties:
- prov:generated: Activity generates Entity
- prov:wasGeneratedBy: Entity was generated by Activity
- prov:used: Activity used Entity
- prov:wasAttributedTo: Entity attributed to Agent

Query Patterns:
1. Find generation: SELECT ?e ?a WHERE {{ ?a prov:generated ?e }}
2. Find usage: SELECT ?a ?e WHERE {{ ?a prov:used ?e }}
"""

print("\nRunning query with guide summary...")
start_time = datetime.now()

try:
    result = rlm(
        question="What activities can generate entities?",
        guide_summary=guide_summary,
        ont=ont
    )

    elapsed = (datetime.now() - start_time).total_seconds()

    print(f"\n{'='*70}")
    print(f"COMPLETED in {elapsed:.1f}s")
    print(f"{'='*70}")
    print(f"\nSPARQL Query:\n{result.sparql_query}")
    print(f"\nExplanation:\n{result.explanation}")

    print(f"\n✓ Test successful!")

except Exception as e:
    print(f"\n✗ Test failed: {e}")
    import traceback
    traceback.print_exc()
