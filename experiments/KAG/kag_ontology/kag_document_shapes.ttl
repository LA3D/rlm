@prefix kag: <http://la3d.local/kag#> .
@prefix doco: <http://purl.org/spar/doco/> .
@prefix deo: <http://purl.org/spar/deo/> .
@prefix sh: <http://www.w3.org/ns/shacl#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .

kag:DocumentShape a sh:NodeShape ;
    sh:targetClass doco:Document ;
    sh:property [
        sh:path kag:contains ;
        sh:qualifiedValueShape [ sh:class doco:Section ] ;
        sh:qualifiedMinCount 1 ;
        sh:message "Document must contain at least one Section via kag:contains. Fix: op_add_iri_link(document_iri, 'kag:contains', section_iri)."
    ] .

kag:SectionShape a sh:NodeShape ;
    sh:targetClass doco:Section ;
    sh:property [
        sh:path kag:containsAsHeader ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:class doco:SectionTitle ;
        sh:message "Section must have exactly one SectionTitle via kag:containsAsHeader. Fix: op_add_iri_link(section_iri, 'kag:containsAsHeader', section_title_iri)."
    ] ;
    sh:property [
        sh:path kag:contains ;
        sh:minCount 1 ;
        sh:message "Section must contain at least one component (Paragraph, Figure, Table, etc.) via kag:contains. Fix: op_add_iri_link(section_iri, 'kag:contains', child_iri) or move orphan nodes into this section."
    ] ;
    sh:property [
        sh:path kag:pageNumber ;
        sh:minCount 1 ;
        sh:datatype xsd:integer ;
        sh:minInclusive 1 ;
        sh:message "Section must have a kag:pageNumber (xsd:integer >= 1). Fix: op_set_single_literal(section_iri, 'kag:pageNumber', page, datatype_iri='xsd:integer')."
    ] ;
    sh:property [
        sh:path kag:hasContentRef ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:datatype xsd:string ;
        sh:pattern "^section:[a-f0-9]{16}$" ;
        sh:message "Section must have kag:hasContentRef matching 'section:' + 16 hex chars. Auto-generated by op_assert_type."
    ] .

kag:ParagraphShape a sh:NodeShape ;
    sh:targetClass doco:Paragraph ;
    sh:property [
        sh:path [ sh:inversePath kag:contains ] ;
        sh:minCount 1 ;
        sh:class doco:Section ;
        sh:message "Paragraph must be contained by a Section. Fix: op_add_iri_link(section_iri, 'kag:contains', this_paragraph_iri)."
    ] ;
    sh:property [
        sh:path kag:hasContentRef ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:datatype xsd:string ;
        sh:pattern "^paragraph:[a-f0-9]{16}$" ;
        sh:message "Paragraph must have kag:hasContentRef matching 'paragraph:' + 16 hex chars. Auto-generated by op_assert_type."
    ] ;
    sh:property [
        sh:path kag:pageNumber ;
        sh:minCount 1 ;
        sh:datatype xsd:integer ;
        sh:minInclusive 1 ;
        sh:message "Paragraph must have kag:pageNumber (xsd:integer >= 1). Fix: op_set_single_literal(para_iri, 'kag:pageNumber', page, datatype_iri='xsd:integer')."
    ] .

kag:FormulaShape a sh:NodeShape ;
    sh:targetClass doco:Formula ;
    sh:property [
        sh:path [ sh:inversePath kag:contains ] ;
        sh:minCount 1 ;
        sh:class doco:Section ;
        sh:message "Formula must be contained by a Section. Fix: op_add_iri_link(section_iri, 'kag:contains', this_formula_iri)."
    ] ;
    sh:property [
        sh:path kag:hasContentRef ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:datatype xsd:string ;
        sh:pattern "^equation:[a-f0-9]{16}$" ;
        sh:message "Formula must have kag:hasContentRef matching 'equation:' + 16 hex chars. Auto-generated by op_assert_type."
    ] .

kag:FigureShape a sh:NodeShape ;
    sh:targetClass doco:Figure ;
    sh:property [
        sh:path [ sh:inversePath kag:contains ] ;
        sh:minCount 1 ;
        sh:class doco:Section ;
        sh:message "Figure must be contained by a Section. Fix: op_add_iri_link(section_iri, 'kag:contains', this_figure_iri)."
    ] ;
    sh:property [
        sh:path kag:hasContentRef ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:datatype xsd:string ;
        sh:pattern "^figure:[a-f0-9]{16}$" ;
        sh:message "Figure must have kag:hasContentRef matching 'figure:' + 16 hex chars. Auto-generated by op_assert_type."
    ] ;
    sh:property [
        sh:path kag:hasBBox ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:datatype xsd:string ;
        sh:message "Figure must have exactly one kag:hasBBox string. Fix: op_set_single_literal(figure_iri, 'kag:hasBBox', bbox_string)."
    ] ;
    sh:property [
        sh:path kag:imageDescription ;
        sh:maxCount 1 ;
        sh:datatype xsd:string
    ] ;
    sh:property [
        sh:path kag:imagePath ;
        sh:maxCount 1 ;
        sh:datatype xsd:string
    ] .

kag:TableShape a sh:NodeShape ;
    sh:targetClass doco:Table ;
    sh:property [
        sh:path [ sh:inversePath kag:contains ] ;
        sh:minCount 1 ;
        sh:class doco:Section ;
        sh:message "Table must be contained by a Section. Fix: op_add_iri_link(section_iri, 'kag:contains', this_table_iri)."
    ] ;
    sh:property [
        sh:path kag:hasContentRef ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:datatype xsd:string ;
        sh:pattern "^table:[a-f0-9]{16}$" ;
        sh:message "Table must have kag:hasContentRef matching 'table:' + 16 hex chars. Auto-generated by op_assert_type."
    ] .

kag:CaptionShape a sh:NodeShape ;
    sh:targetClass deo:Caption ;
    sh:property [
        sh:path [ sh:inversePath kag:contains ] ;
        sh:minCount 1 ;
        sh:class doco:Section ;
        sh:message "Caption must be contained by a Section. Fix: op_add_iri_link(section_iri, 'kag:contains', this_caption_iri)."
    ] ;
    sh:property [
        sh:path kag:hasContentRef ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:datatype xsd:string ;
        sh:pattern "^caption:[a-f0-9]{16}$" ;
        sh:message "Caption must have kag:hasContentRef matching 'caption:' + 16 hex chars. Auto-generated by op_assert_type."
    ] ;
    sh:property [
        sh:path kag:describes ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:or (
            [ sh:class doco:Figure ]
            [ sh:class doco:Table ]
        ) ;
        sh:message "Caption must describe exactly one Figure or Table via kag:describes. Fix: op_add_iri_link(caption_iri, 'kag:describes', figure_or_table_iri). Read the caption text to identify which Figure/Table it refers to."
    ] .
