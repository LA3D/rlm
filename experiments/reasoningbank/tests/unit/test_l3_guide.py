"""Test L3 guide layer correctness."""

import sys
sys.path.insert(0, '/Users/cvardema/dev/git/LA3D/rlm')

from experiments.reasoningbank.prototype.packers import l3_guide

print("=" * 70)
print("L3 GUIDE COMPRESSION TEST")
print("=" * 70)

# Example full guide (like what E3-E4 experiments produce)
full_guide = """# PROV Ontology Guide

## Overview
The W3C PROV ontology defines a data model for provenance information. It captures the relationships between entities, activities, and agents involved in producing data or things.

## Core Classes
- **Entity**: A physical, digital, or conceptual thing that has some fixed aspects.
- **Activity**: Something that occurs over a period of time and acts upon or with entities.
- **Agent**: Something that bears responsibility for an activity or entity.

## Key Properties
- `wasGeneratedBy`: Links an Entity to the Activity that generated it.
- `used`: Links an Activity to an Entity it used.
- `wasAttributedTo`: Links an Entity to the Agent responsible for it.
- `wasAssociatedWith`: Links an Activity to the Agent involved.
- `actedOnBehalfOf`: Links an Agent to another Agent it acted on behalf of.

## Query Patterns
1. **Find entities generated by an activity:**
   ```sparql
   SELECT ?entity WHERE { ?entity prov:wasGeneratedBy ?activity }
   ```

2. **Find the provenance chain:**
   ```sparql
   SELECT ?entity ?activity ?agent WHERE {
     ?entity prov:wasGeneratedBy ?activity .
     ?activity prov:wasAssociatedWith ?agent .
   }
   ```

## Anti-patterns
- Don't query for both Entity and Activity types on the same variable (disjoint).
- Always specify rdf:type when querying for class instances.
- Use qualified relations (e.g., qualifiedGeneration) for detailed provenance.
"""

print(f"\nFull guide length: {len(full_guide)} chars")
print(f"Full guide lines: {full_guide.count(chr(10))+1}")

# Test 1: Budget larger than guide
print("\n" + "-" * 70)
print("TEST 1: Budget larger than guide (no compression)")
print("-" * 70)

packed_2000 = l3_guide.pack(full_guide, budget=2000)
print(f"Budget: 2000, Result length: {len(packed_2000)}")
check1 = packed_2000 == full_guide
print(f"✓ Returns full guide when budget > length: {check1}")

# Test 2: Budget smaller than guide
print("\n" + "-" * 70)
print("TEST 2: Budget smaller than guide (truncation)")
print("-" * 70)

packed_500 = l3_guide.pack(full_guide, budget=500)
print(f"Budget: 500, Result length: {len(packed_500)}")
check2 = len(packed_500) <= 500
print(f"✓ Result within budget: {check2}")

# Test 3: Truncation at sentence boundary
print("\n" + "-" * 70)
print("TEST 3: Truncation at sentence boundary")
print("-" * 70)

# Check if it ends at a sentence boundary
check3 = packed_500.rstrip().endswith('.') or packed_500.rstrip().endswith('!')
print(f"Last chars: '{packed_500[-50:]}'")
print(f"✓ Ends at sentence boundary: {check3}")

# Test 4: Small budget
print("\n" + "-" * 70)
print("TEST 4: Very small budget")
print("-" * 70)

packed_100 = l3_guide.pack(full_guide, budget=100)
print(f"Budget: 100, Result length: {len(packed_100)}")
check4 = len(packed_100) <= 100
print(f"✓ Result within small budget: {check4}")

# Test 5: Budget = 1000 (typical E4 setting)
print("\n" + "-" * 70)
print("TEST 5: Budget = 1000 (E4 setting)")
print("-" * 70)

packed_1000 = l3_guide.pack(full_guide, budget=1000)
print(f"Budget: 1000, Result length: {len(packed_1000)}")
print("\nPacked output:")
print(packed_1000[:500] + "..." if len(packed_1000) > 500 else packed_1000)
check5 = len(packed_1000) <= 1000
print(f"\n✓ Result within E4 budget: {check5}")

# Summary
print("\n" + "=" * 70)
print("VERIFICATION SUMMARY")
print("=" * 70)

checks = {
    'No compression when under budget': check1,
    'Truncation respects budget': check2,
    'Ends at sentence boundary': check3,
    'Small budget works': check4,
    'E4 budget (1000) works': check5,
}

for name, passed in checks.items():
    status = "✓" if passed else "✗"
    print(f"{status} {name}")

if all(checks.values()):
    print("\n✓ L3 GUIDE COMPRESSION WORKS CORRECTLY")
else:
    print("\n✗ SOME CHECKS FAILED")

print("=" * 70)
